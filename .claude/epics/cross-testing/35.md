---
name: Refactor Providers and Standardize Error Handling
status: open
created: 2025-08-26T02:45:00Z
updated: 2025-08-26T02:44:09+02:00
github: https://github.com/quazardous/repocli/issues/35
depends_on: [34]
parallel: false
conflicts_with: []
---

# Task: Refactor Providers and Standardize Error Handling

## Description
Address critical technical debt in the REPOCLI provider system by refactoring the GitLab provider for better maintainability, standardizing error handling patterns across all providers, and improving test coverage for edge cases. This task builds on the CI improvements from Task #34 to ensure a solid foundation for provider enhancements.

**üéØ PRIMARY FOCUS**: Clean up provider architecture and establish consistent patterns for maintainability and reliability.

## Problem Statement
Current provider system has accumulated technical debt:
- **GitLab provider complexity**: Complex command translation logic is hard to maintain
- **Inconsistent error handling**: Each provider handles errors differently  
- **Edge case gaps**: Missing test coverage for error scenarios and edge cases
- **Code duplication**: Similar patterns repeated across providers

## Acceptance Criteria

### GitLab Provider Refactoring
- [ ] **Extract Command Mappers**: Separate command translation logic into focused functions
- [ ] **Simplify Parameter Translation**: Create reusable parameter mapping utilities
- [ ] **JSON Processing Cleanup**: Standardize JSON field mapping and query handling
- [ ] **Instance URL Handling**: Clean up custom GitLab instance logic
- [ ] **Function Decomposition**: Break large functions into focused, testable units

### Standardized Error Handling
- [ ] **Common Error Patterns**: Establish standard error response formats
- [ ] **Consistent Exit Codes**: Standardize exit code meanings across providers
- [ ] **Error Message Templates**: Create consistent, helpful error messages
- [ ] **CLI Tool Validation**: Standard approach for checking CLI tool availability
- [ ] **Graceful Degradation**: Consistent fallback behavior when tools missing

### Enhanced Test Coverage
- [ ] **Edge Case Testing**: Test error scenarios, missing tools, invalid inputs
- [ ] **Provider Comparison**: Ensure consistent behavior across providers
- [ ] **Error Path Validation**: Test all error handling code paths
- [ ] **Mock Integration**: Leverage Task #30 mock system for comprehensive testing
- [ ] **Regression Prevention**: Tests for known issues and fixes

## Technical Details

### GitLab Provider Refactoring Strategy

**Current State Issues:**
```bash
# lib/providers/gitlab.sh - Current problems:
# - gitlab_issue_view(): 80+ lines, handles multiple concerns
# - Parameter parsing scattered throughout functions
# - JSON field mapping duplicated in multiple places
# - Error handling inconsistent across commands
```

**Proposed Refactoring:**
```bash
# lib/providers/gitlab.sh - Refactored structure:

# Command routing (simplified)
gitlab_execute() {
    local cmd="$1"; shift
    case "$cmd" in
        "auth") gitlab_auth_handler "$@" ;;
        "issue") gitlab_issue_handler "$@" ;;
        "repo") gitlab_repo_handler "$@" ;;
        *) handle_unknown_command "$cmd" "$@" ;;
    esac
}

# Focused command handlers
gitlab_issue_handler() {
    local subcmd="$1"; shift
    case "$subcmd" in
        "view") gitlab_issue_view_command "$@" ;;
        "create") gitlab_issue_create_command "$@" ;;
        "comment") gitlab_issue_comment_command "$@" ;;
        *) handle_unknown_subcommand "issue" "$subcmd" "$@" ;;
    esac
}

# Reusable utilities
gitlab_translate_parameters() {
    local -A param_map=(
        ["--body-file"]="--description-file"
        ["--json"]="--output json"
    )
    translate_params param_map "$@"
}

gitlab_normalize_json() {
    local json_input="$1"
    local field_mappings="$2"
    echo "$json_input" | jq "$field_mappings"
}
```

### Standardized Error Handling Framework

**Common Error Handler:**
```bash
# lib/utils.sh - Standard error handling
handle_provider_error() {
    local provider="$1"
    local command="$2" 
    local exit_code="$3"
    local error_output="$4"
    
    case "$exit_code" in
        127) 
            echo "Error: $provider CLI tool not found. Install with: ${INSTALL_COMMANDS[$provider]}" >&2
            return 1
            ;;
        1)
            if echo "$error_output" | grep -q "authentication\|login"; then
                echo "Error: Not authenticated to $provider. Run: repocli auth login" >&2
                return 1
            fi
            ;;
        *)
            echo "Error: $provider command failed: $error_output" >&2
            return "$exit_code"
            ;;
    esac
}

# Standard CLI tool validation
check_cli_tool() {
    local tool="$1"
    local provider="$2"
    
    if ! command -v "$tool" >/dev/null 2>&1; then
        echo "Error: $tool CLI not found" >&2
        echo "Install $provider CLI: ${INSTALL_COMMANDS[$provider]}" >&2
        return 1
    fi
    
    # Basic functionality check
    if ! "$tool" --version >/dev/null 2>&1; then
        echo "Error: $tool CLI not working properly" >&2
        return 1
    fi
}
```

### Enhanced Test Coverage Strategy

**Edge Case Test Categories:**
1. **Missing CLI Tools**: Test behavior when `gh`/`glab` not installed
2. **Authentication Failures**: Test unauthenticated scenarios  
3. **Network Issues**: Test timeout and connection failures
4. **Invalid Parameters**: Test malformed arguments and edge cases
5. **JSON Processing**: Test malformed JSON responses and field mapping
6. **Custom Instances**: Test GitLab custom instance edge cases

**Implementation:**
```bash
# tests/cross-testing/lib/edge-case-tests.sh
test_missing_cli_tool() {
    echo "üß™ Testing missing CLI tool handling..."
    
    # Temporarily hide CLI tool from PATH
    local original_path="$PATH"
    export PATH="/tmp/empty:$PATH"
    
    # Should fail gracefully with helpful message
    local output error_code
    output=$(repocli --version 2>&1) && error_code=$? || error_code=$?
    
    export PATH="$original_path"
    
    if [[ $error_code -ne 0 ]] && echo "$output" | grep -q "CLI not found"; then
        echo "‚úÖ Missing CLI tool handled gracefully"
    else
        echo "‚ùå Missing CLI tool handling failed"
        return 1
    fi
}

test_authentication_failures() {
    echo "üß™ Testing authentication failure scenarios..."
    
    # Test with mock that simulates auth failure
    export REPOCLI_MOCK_SCENARIO="auth_fail"
    
    local output error_code
    output=$(repocli auth status 2>&1) && error_code=$? || error_code=$?
    
    if [[ $error_code -ne 0 ]] && echo "$output" | grep -q "Not authenticated"; then
        echo "‚úÖ Authentication failure handled correctly"
    else
        echo "‚ùå Authentication failure handling failed"
        return 1
    fi
}
```

## Implementation Priority

**Phase 1: Error Handling Standardization (High Impact, Low Risk)**
1. Create common error handling utilities in `lib/utils.sh`
2. Update all providers to use standard error patterns
3. Add comprehensive CLI tool validation
4. Test error scenarios with existing test suite

**Phase 2: GitLab Provider Refactoring (High Impact, Medium Risk)**  
1. Extract parameter translation utilities
2. Break down large functions into focused handlers
3. Standardize JSON processing approach
4. Maintain backward compatibility throughout

**Phase 3: Enhanced Test Coverage (Medium Impact, Low Risk)**
1. Add edge case tests leveraging Task #30 mock system
2. Test error paths and failure scenarios  
3. Add provider comparison tests
4. Integrate with CI pipeline for regression prevention

## Dependencies
- [ ] **Task #34**: CI failure analysis and fixes (must be completed first)
- [ ] **Task #30**: Mock system foundation (already completed)
- [ ] Understanding of current provider patterns and pain points
- [ ] Existing test infrastructure from cross-testing framework

## Definition of Done
- [ ] GitLab provider functions are < 50 lines each (maintainability)
- [ ] All providers use common error handling patterns
- [ ] 90%+ test coverage including edge cases and error paths
- [ ] No regression in existing functionality (all current tests pass)
- [ ] Provider behavior is consistent across GitHub/GitLab
- [ ] Error messages are helpful and actionable
- [ ] Code is well-documented with clear separation of concerns

## Effort Estimate
- **Size**: L (Large)
- **Hours**: 16-24 hours
- **Risk**: Medium (refactoring existing working code)
- **Parallel**: No (requires stable CI foundation from Task #34)

## Usage Examples After Completion

```bash
# Consistent error handling across providers
repocli auth status
# Error: GitHub CLI not found
# Install GitHub CLI: https://cli.github.com/

# Improved maintainability - cleaner code structure  
# lib/providers/gitlab.sh will have focused, testable functions
# JSON processing will be consistent and reusable

# Enhanced testing coverage
./tests/cross-testing/run-edge-case-tests.sh
# ‚úÖ Missing CLI tools: 5/5 tests passed
# ‚úÖ Authentication failures: 3/3 tests passed  
# ‚úÖ Network issues: 4/4 tests passed
```

This task establishes the foundation for reliable, maintainable provider system that can support future enhancements with confidence.
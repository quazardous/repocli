---
name: Add assignee and label management for issue editing
status: open
created: 2025-08-25T14:35:00Z
updated: 
github: 
depends_on: [20]
parallel: true
conflicts_with: []
priority: high
type: feature
---

# Task 20c: Add assignee and label management for issue editing

## Description
Implement comprehensive assignee and label management in `gh issue edit` commands to support PM system workflows. Current REPOCLI wrapper lacks support for `--add-assignee`, `--remove-assignee`, `--add-label`, and `--remove-label` parameters.

## Problem Statement
PM system uses sophisticated issue editing patterns that currently fail:
```bash
gh issue edit #N --add-assignee @me --add-label "in-progress"
gh issue edit #N --remove-label "todo" --add-label "done"
gh issue edit #N --remove-assignee --add-assignee @someone
```

These commands are essential for automated task assignment and status tracking in epic workflows.

## Acceptance Criteria

### Assignee Management
- [ ] Support `--add-assignee username` parameter
- [ ] Support `--add-assignee @me` with current user resolution
- [ ] Support `--remove-assignee username` parameter  
- [ ] Support `--remove-assignee` (remove all assignees)
- [ ] Handle multiple assignee operations in single command
- [ ] Map GitHub usernames to GitLab usernames when possible

### Label Management
- [ ] Support `--add-label "label-name"` parameter
- [ ] Support `--remove-label "label-name"` parameter
- [ ] Handle multiple label operations in single command
- [ ] Preserve existing labels when adding/removing specific ones
- [ ] Support labels with spaces and special characters

### Parameter Integration
- [ ] Combine assignee/label operations with existing edit parameters
- [ ] Maintain backward compatibility with current edit functionality
- [ ] Support JSON output for edit operations when requested
- [ ] Proper error handling for invalid users/labels

## Implementation Details

### 1. Enhanced Issue Edit Function
```bash
gitlab_issue_edit() {
    local issue="$1"; shift
    local title="" description="" body_file=""
    local add_assignees=() remove_assignees=()
    local add_labels=() remove_labels=()
    local json_output=false query=""
    local glab_args=()
    
    # Parse all edit parameters
    while [[ $# -gt 0 ]]; do
        case "$1" in
            "--title")
                title="$2"
                shift 2
                ;;
            "--body")
                description="$2"
                shift 2
                ;;
            "--body-file")
                body_file="$2"
                shift 2
                ;;
            "--add-assignee")
                local assignee="$2"
                [[ "$assignee" == "@me" ]] && assignee=$(get_current_gitlab_user)
                add_assignees+=("$assignee")
                shift 2
                ;;
            "--remove-assignee")
                if [[ -n "$2" && ! "$2" =~ ^-- ]]; then
                    local assignee="$2"
                    [[ "$assignee" == "@me" ]] && assignee=$(get_current_gitlab_user)
                    remove_assignees+=("$assignee")
                    shift 2
                else
                    # Remove all assignees
                    remove_assignees+=("__ALL__")
                    shift
                fi
                ;;
            "--add-label")
                add_labels+=("$2")
                shift 2
                ;;
            "--remove-label")
                remove_labels+=("$2")
                shift 2
                ;;
            "--json")
                json_output=true
                json_fields="$2"
                shift 2
                ;;
            "-q"|"--jq")
                query="$2"
                shift 2
                ;;
            *)
                # Pass unknown arguments to glab
                glab_args+=("$1")
                if [[ -n "$2" && ! "$2" =~ ^-- ]]; then
                    glab_args+=("$2")
                    shift 2
                else
                    shift
                fi
                ;;
        esac
    done
    
    # Build glab edit command
    [[ -n "$title" ]] && glab_args+=(--title "$title")
    [[ -n "$description" ]] && glab_args+=(--description "$description")
    [[ -n "$body_file" ]] && glab_args+=(--description-file "$body_file")
    
    # Handle assignee changes
    if [[ ${#add_assignees[@]} -gt 0 || ${#remove_assignees[@]} -gt 0 ]]; then
        local current_assignees new_assignees
        current_assignees=$(glab issue view "$issue" --output json | jq -r '.assignees[]?.username // empty')
        new_assignees=()
        
        # Start with current assignees
        while read -r assignee; do
            [[ -n "$assignee" ]] && new_assignees+=("$assignee")
        done <<< "$current_assignees"
        
        # Remove specified assignees
        for remove_assignee in "${remove_assignees[@]}"; do
            if [[ "$remove_assignee" == "__ALL__" ]]; then
                new_assignees=()
                break
            else
                new_assignees=(${new_assignees[@]/$remove_assignee})
            fi
        done
        
        # Add new assignees (avoid duplicates)
        for add_assignee in "${add_assignees[@]}"; do
            if [[ ! " ${new_assignees[@]} " =~ " $add_assignee " ]]; then
                new_assignees+=("$add_assignee")
            fi
        done
        
        # Apply assignee list to glab command
        if [[ ${#new_assignees[@]} -gt 0 ]]; then
            local assignee_list=$(IFS=','; echo "${new_assignees[*]}")
            glab_args+=(--assignee "$assignee_list")
        else
            glab_args+=(--unassign)
        fi
    fi
    
    # Handle label changes
    if [[ ${#add_labels[@]} -gt 0 || ${#remove_labels[@]} -gt 0 ]]; then
        local current_labels new_labels
        current_labels=$(glab issue view "$issue" --output json | jq -r '.labels[]? // empty')
        new_labels=()
        
        # Start with current labels
        while read -r label; do
            [[ -n "$label" ]] && new_labels+=("$label")
        done <<< "$current_labels"
        
        # Remove specified labels
        for remove_label in "${remove_labels[@]}"; do
            new_labels=(${new_labels[@]/$remove_label})
        done
        
        # Add new labels (avoid duplicates)
        for add_label in "${add_labels[@]}"; do
            if [[ ! " ${new_labels[@]} " =~ " $add_label " ]]; then
                new_labels+=("$add_label")
            fi
        done
        
        # Apply label list to glab command
        if [[ ${#new_labels[@]} -gt 0 ]]; then
            local label_list=$(IFS=','; echo "${new_labels[*]}")
            glab_args+=(--label "$label_list")
        fi
    fi
    
    # Execute the edit command
    if [[ "$json_output" == true ]]; then
        # Edit and return JSON response
        glab issue edit "$issue" "${glab_args[@]}" >/dev/null
        local updated_json=$(glab issue view "$issue" --output json)
        local normalized=$(normalize_gitlab_json_fields "$updated_json")
        
        if [[ -n "$json_fields" && "$json_fields" != "." ]]; then
            local field_selector="{$(echo "$json_fields" | sed 's/,/: .,/g'): .}"
            normalized=$(echo "$normalized" | jq "$field_selector")
        fi
        
        if [[ -n "$query" ]]; then
            echo "$normalized" | jq -r "$query"
        else
            echo "$normalized"
        fi
    else
        glab issue edit "$issue" "${glab_args[@]}"
    fi
}
```

### 2. Current User Resolution
```bash
# Get current GitLab username for @me resolution
get_current_gitlab_user() {
    local auth_output=$(glab auth status 2>/dev/null)
    if echo "$auth_output" | grep -q "Logged in"; then
        echo "$auth_output" | grep -oE 'Logged in.*as [^ ]+' | awk '{print $NF}' | tr -d '()'
    else
        echo "Error: Not logged into GitLab" >&2
        return 1
    fi
}
```

### 3. Label and Assignee Validation
```bash
# Validate assignee exists in GitLab
validate_gitlab_assignee() {
    local username="$1"
    if ! glab api users --search "$username" | jq -e ".[] | select(.username == \"$username\")" >/dev/null 2>&1; then
        echo "Warning: User $username not found in GitLab" >&2
        return 1
    fi
    return 0
}

# Validate label exists in repository
validate_gitlab_label() {
    local label="$1"
    local repo_labels=$(glab repo view --output json | jq -r '.labels[]?.name // empty')
    if ! echo "$repo_labels" | grep -qx "$label"; then
        echo "Warning: Label '$label' not found in repository" >&2
        # Note: GitLab will create labels automatically, so this is just a warning
    fi
    return 0
}
```

## PM System Integration

### Commands that will work after implementation:
```bash
# From /pm:issue-start
repocli issue edit #123 --add-assignee @me --add-label "in-progress"

# From epic management workflows
repocli issue edit #456 --remove-label "todo" --add-label "done"

# From assignment management
repocli issue edit #789 --remove-assignee old-user --add-assignee new-user
```

## Testing Strategy

### Basic Assignee Tests
```bash
test_assignee_management() {
    local test_issue=$(get_test_issue)
    [[ "$test_issue" == "SKIP" ]] && return 0
    
    # Test add assignee (@me)
    repocli issue edit "$test_issue" --add-assignee @me
    local assignees=$(repocli issue view "$test_issue" --json assignees -q '.assignees[].login')
    local current_user=$(get_current_gitlab_user)
    assert_contains "$assignees" "$current_user" "Should assign current user"
    
    # Test remove assignee
    repocli issue edit "$test_issue" --remove-assignee @me
    assignees=$(repocli issue view "$test_issue" --json assignees -q '.assignees[]?.login // empty')
    assert_not_contains "$assignees" "$current_user" "Should remove current user"
    
    echo "✅ Assignee management working"
}

test_label_management() {
    local test_issue=$(get_test_issue) 
    [[ "$test_issue" == "SKIP" ]] && return 0
    
    # Test add label
    repocli issue edit "$test_issue" --add-label "test-label"
    local labels=$(repocli issue view "$test_issue" --json labels -q '.labels[].name')
    assert_contains "$labels" "test-label" "Should add label"
    
    # Test remove label
    repocli issue edit "$test_issue" --remove-label "test-label"
    labels=$(repocli issue view "$test_issue" --json labels -q '.labels[]?.name // empty')
    assert_not_contains "$labels" "test-label" "Should remove label"
    
    echo "✅ Label management working"
}
```

### Complex Operation Tests
```bash
test_combined_edit_operations() {
    local test_issue=$(get_test_issue)
    [[ "$test_issue" == "SKIP" ]] && return 0
    
    # Test combined title, assignee, and label changes
    repocli issue edit "$test_issue" \
        --title "Updated Title" \
        --add-assignee @me \
        --add-label "updated" \
        --remove-label "old-label"
        
    # Verify all changes applied
    local issue_data=$(repocli issue view "$test_issue" --json title,assignees,labels)
    
    assert_contains "$(echo "$issue_data" | jq -r '.title')" "Updated Title" "Title should be updated"
    assert_contains "$(echo "$issue_data" | jq -r '.assignees[].login')" "$(get_current_gitlab_user)" "Should be assigned"
    assert_contains "$(echo "$issue_data" | jq -r '.labels[].name')" "updated" "Should have new label"
    
    echo "✅ Combined edit operations working"
}
```

## Error Handling

### User Experience
- Clear error messages for invalid users: "User 'nonexistent' not found in GitLab"
- Warnings for non-existent labels: "Label 'typo-label' not found (will be created)"
- Graceful handling of permission errors: "Cannot assign user 'restricted-user'"

### Fallback Strategies
- If assignee validation fails, continue with edit but warn user
- If label validation fails, let GitLab create label automatically
- If authentication fails for user resolution, provide clear instructions

## Dependencies
- Task 20: Main PM system coverage task
- Task 20b: JSON query support (for JSON output mode)
- Understanding of GitLab user and label APIs
- Access to GitLab test repository with appropriate permissions

## Definition of Done
- [ ] All assignee operations work: `--add-assignee`, `--remove-assignee`
- [ ] `@me` resolution works correctly for current GitLab user
- [ ] All label operations work: `--add-label`, `--remove-label`
- [ ] Combined operations work in single command
- [ ] JSON output mode works for edit operations
- [ ] PM system assignment workflows work on GitLab
- [ ] Comprehensive error handling and user feedback
- [ ] Edge cases handled (non-existent users, labels, permissions)

## Effort Estimate
- Size: M
- Hours: 10-14 hours
- High priority for PM system task management workflows
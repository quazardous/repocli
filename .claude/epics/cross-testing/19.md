---
name: Add comprehensive tests for issue close/reopen operations
status: open
created: 2025-08-25T14:15:00Z
updated: 
github: 
depends_on: [16]
parallel: true
conflicts_with: []
priority: normal
type: testing
---

# Task: Add comprehensive tests for issue close/reopen operations

## Description
Implement comprehensive testing for issue state management (close/reopen) operations across providers, including state transitions, reason handling, comment attachment, and JSON output consistency. This ensures REPOCLI properly handles the lifecycle management differences between GitHub and GitLab.

## Problem Analysis

**GitHub vs GitLab Issue State Management:**

| Aspect | GitHub (`gh`) | GitLab (`glab`) |
|--------|---------------|-----------------|
| **Close command** | `gh issue close #123` | `glab issue close #123` |
| **Close with reason** | `gh issue close #123 --reason "not planned"` | `glab issue close #123` (no reason param) |
| **Close with comment** | `gh issue close #123 --comment "Closing because..."` | `glab issue close #123 -m "Closing because..."` |
| **Reopen command** | `gh issue reopen #123` | `glab issue reopen #123` |
| **Reopen with comment** | `gh issue reopen #123 --comment "Reopening..."` | `glab issue reopen #123 -m "Reopening..."` |
| **State values** | `"open"`, `"closed"` | `"opened"`, `"closed"` |
| **Close reasons** | `"completed"`, `"not_planned"` | No native reasons |
| **Bulk operations** | `gh issue close #1 #2 #3` | `glab issue close #1 #2 #3` |
| **JSON output** | `"state": "closed", "state_reason": "completed"` | `"state": "closed"` |

## Key Differences to Handle

### 1. State Value Translation
- GitHub: `"open"` ↔ GitLab: `"opened"`  
- Both use: `"closed"` (same)

### 2. Close Reasons (GitHub-specific)
- **GitHub**: `completed`, `not_planned`
- **GitLab**: No native support → Handle via comments

### 3. Comment Parameter Differences  
- **GitHub**: `--comment "text"`
- **GitLab**: `-m "text"` or `--message "text"`

### 4. JSON Output Normalization
- Standardize state values across providers
- Handle missing `state_reason` in GitLab responses

## Acceptance Criteria

### Core Operations
- [ ] Basic close: `repocli issue close #123`
- [ ] Close with comment: `repocli issue close #123 --comment "Done"`
- [ ] Close with reason: `repocli issue close #123 --reason completed`
- [ ] Bulk close: `repocli issue close #123 #124 #125`
- [ ] Basic reopen: `repocli issue reopen #123`
- [ ] Reopen with comment: `repocli issue reopen #123 --comment "Still needed"`
- [ ] Bulk reopen: `repocli issue reopen #123 #124 #125`

### GitLab Provider Translation
- [ ] Map `--comment` to `-m` parameter
- [ ] Handle `--reason` by adding reason to comment text
- [ ] Normalize GitLab `"opened"` to `"open"` in JSON output
- [ ] Add synthetic `"state_reason"` field for consistency

### Cross-Testing Validation
- [ ] State transition equivalence between providers
- [ ] Comment attachment working correctly
- [ ] Bulk operations handling same number of issues
- [ ] JSON output consistency for state fields
- [ ] Error handling for non-existent issues
- [ ] Permission error handling (can't close/reopen)

## Implementation Requirements

### 1. GitLab Provider Enhancements

```bash
# In lib/providers/gitlab.sh
gitlab_issue_close() {
    local issues=() comment="" reason=""
    
    # Parse arguments
    while [[ $# -gt 0 ]]; do
        case "$1" in
            "--comment") comment="$2"; shift 2 ;;
            "--reason") reason="$2"; shift 2 ;;
            "#"*|[0-9]*) issues+=("$(echo "$1" | sed 's/^#//')"); shift ;;
            *) shift ;;
        esac
    done
    
    # Combine reason and comment
    local full_message=""
    [[ -n "$reason" ]] && full_message="Closed as: $reason"
    [[ -n "$comment" ]] && {
        [[ -n "$full_message" ]] && full_message+="\n\n"
        full_message+="$comment"
    }
    
    # Close issues
    for issue in "${issues[@]}"; do
        if [[ -n "$full_message" ]]; then
            glab issue close "$issue" -m "$full_message"
        else
            glab issue close "$issue"
        fi
    done
}

gitlab_issue_reopen() {
    local issues=() comment=""
    
    # Parse arguments  
    while [[ $# -gt 0 ]]; do
        case "$1" in
            "--comment") comment="$2"; shift 2 ;;
            "#"*|[0-9]*) issues+=("$(echo "$1" | sed 's/^#//')"); shift ;;
            *) shift ;;
        esac
    done
    
    # Reopen issues
    for issue in "${issues[@]}"; do
        if [[ -n "$comment" ]]; then
            glab issue reopen "$issue" -m "$comment"
        else
            glab issue reopen "$issue"
        fi
    done
}
```

### 2. JSON Output Normalization

```bash
# Normalize GitLab issue state output
normalize_gitlab_issue_state() {
    local json="$1"
    echo "$json" | jq '
        # Convert "opened" to "open" for consistency
        .state = (if .state == "opened" then "open" else .state end) |
        
        # Add synthetic state_reason if missing
        if has("state_reason") | not then
            .state_reason = (if .state == "closed" then "completed" else null end)
        else . end
    '
}

# Apply to issue view/list commands
gitlab_issue_view() {
    local raw_output=$(glab issue view "$@" --output json)
    normalize_gitlab_issue_state "$raw_output"
}
```

### 3. Cross-Testing Integration

```bash
# Test state transitions
test_issue_state_transitions() {
    local test_mode="$1"  # from test configuration
    local test_issue
    
    # Get or create test issue
    test_issue=$(get_test_issue)
    [[ "$test_issue" == "SKIP" ]] && return 0
    
    # Test close operation
    echo "Testing issue close..."
    repocli issue close "$test_issue" --comment "Test close operation"
    
    # Verify closed state
    local state=$(repocli issue view "$test_issue" --json state -q '.state')
    assert_equals "$state" "closed" "Issue should be closed"
    
    # Test reopen operation  
    echo "Testing issue reopen..."
    repocli issue reopen "$test_issue" --comment "Test reopen operation"
    
    # Verify open state
    state=$(repocli issue view "$test_issue" --json state -q '.state')
    assert_equals "$state" "open" "Issue should be reopened"
    
    echo "✅ State transition tests passed"
}

# Test bulk operations
test_bulk_state_operations() {
    local test_mode="$1"
    local issues=()
    
    # Create multiple test issues if needed
    case "$test_mode" in
        "auto_create"|"hybrid")
            for i in {1..3}; do
                issues+=($(create_temp_test_issue "Bulk test issue $i"))
            done
            ;;
        *)
            echo "Skipping bulk tests (requires issue creation)"
            return 0
            ;;
    esac
    
    # Test bulk close
    echo "Testing bulk close: ${issues[*]}"
    repocli issue close "${issues[@]}" --comment "Bulk close test"
    
    # Verify all closed
    for issue in "${issues[@]}"; do
        local state=$(repocli issue view "$issue" --json state -q '.state')
        assert_equals "$state" "closed" "Issue #$issue should be closed"
    done
    
    # Test bulk reopen
    echo "Testing bulk reopen: ${issues[*]}"
    repocli issue reopen "${issues[@]}" --comment "Bulk reopen test"
    
    # Verify all reopened
    for issue in "${issues[@]}"; do
        local state=$(repocli issue view "$issue" --json state -q '.state')
        assert_equals "$state" "open" "Issue #$issue should be reopened"
    done
    
    echo "✅ Bulk operation tests passed"
}
```

### 4. Reason Handling Tests

```bash
# Test GitHub-style close reasons on GitLab
test_close_reasons() {
    local test_issue=$(get_test_issue)
    [[ "$test_issue" == "SKIP" ]] && return 0
    
    # Test close with reason
    repocli issue close "$test_issue" --reason "not_planned" --comment "This feature is not needed"
    
    # For GitLab, verify reason appears in comments/description
    if [[ "$REPOCLI_PROVIDER" == "gitlab" ]]; then
        # Check that reason was added to comment
        local comments=$(glab issue view "$test_issue" --comments)
        assert_contains "$comments" "Closed as: not_planned" "Reason should be in comments"
    fi
    
    echo "✅ Close reason tests passed"
}
```

### 5. Error Handling Tests

```bash
# Test error scenarios
test_state_operation_errors() {
    # Test non-existent issue
    local output
    output=$(repocli issue close 999999 2>&1) || true
    assert_contains "$output" "not found\|doesn't exist" "Should error on non-existent issue"
    
    # Test already closed issue
    local test_issue=$(get_test_issue)
    repocli issue close "$test_issue" >/dev/null 2>&1
    output=$(repocli issue close "$test_issue" 2>&1) || true
    # Note: Different providers may handle this differently
    
    echo "✅ Error handling tests passed"
}
```

## Cross-Provider Output Comparison

### GitHub Output Format
```json
{
  "number": 123,
  "title": "Test Issue",
  "state": "closed",
  "state_reason": "completed",
  "closed_at": "2025-08-25T14:15:00Z",
  "closed_by": {
    "login": "username"
  }
}
```

### GitLab Output Format (Normalized)
```json
{
  "iid": 123,
  "title": "Test Issue", 
  "state": "closed",
  "state_reason": "completed",
  "closed_at": "2025-08-25T14:15:00Z",
  "closed_by": {
    "username": "username"
  }
}
```

## Test Integration Strategy

### 1. Test Mode Compatibility
- **Read-only mode**: Skip state change tests
- **Hybrid/Auto-create mode**: Full state transition testing
- **Existing-only mode**: Only test if issues are available

### 2. Test Cleanup
```bash
# Always restore test issues to known state
cleanup_state_tests() {
    local test_issues=("$@")
    for issue in "${test_issues[@]}"; do
        # Ensure issues are in open state for next test run
        repocli issue reopen "$issue" --comment "Restored for next test" >/dev/null 2>&1 || true
    done
}
```

### 3. Performance Testing
- Measure time for bulk operations
- Test rate limiting behavior
- Validate API call efficiency

## Dependencies
- [ ] Task 16: Wrapper option handling fixes
- [ ] Task 14: Test configuration setup (for test modes)
- [ ] Understanding of provider-specific state management
- [ ] Access to test repositories with issues

## Effort Estimate
- Size: M
- Hours: 10-14 hours
- Parallel: true (extends existing testing)

## Definition of Done
- [ ] All state operations work correctly through REPOCLI
- [ ] GitLab provider properly translates parameters and output
- [ ] Cross-testing validates state transitions across providers
- [ ] Bulk operations handle multiple issues correctly
- [ ] Error cases are handled gracefully
- [ ] JSON output is consistent between providers
- [ ] Different test modes are supported appropriately

## Usage Examples

```bash
# Basic operations
repocli issue close #123
repocli issue reopen #123

# With comments and reasons
repocli issue close #123 --reason "completed" --comment "Feature implemented"
repocli issue reopen #123 --comment "Need to fix edge case"

# Bulk operations
repocli issue close #123 #124 #125 --comment "Batch closing resolved issues"

# Cross-testing
./tests/cross-testing/run-cross-tests.sh state-operations
```

This task ensures robust issue lifecycle management across all supported providers with comprehensive testing of edge cases and error scenarios.
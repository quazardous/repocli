---
name: Add extension command framework and sub-issue simulation
status: open
created: 2025-08-25T14:25:00Z
updated: 2025-08-25T14:12:19Z
last_sync: 2025-08-25T23:03:33+02:00
github: https://github.com/quazardous/repocli/issues/23 
depends_on: [22]
parallel: false
conflicts_with: []
priority: critical
type: feature
---

# Task 20a: Add extension command framework and sub-issue simulation

## Description
Implement extension command handling in REPOCLI wrapper with focus on `gh sub-issue` functionality used extensively by PM system. This critical functionality enables epic decomposition workflows on GitLab provider.

## Problem Statement
PM system relies heavily on:
```bash
gh extension install yahsan2/gh-sub-issue
gh sub-issue create --parent N --title "X" --body-file Y --label "Z"
```

Current REPOCLI wrapper has **zero extension support**, causing PM workflows to fail completely on GitLab.

## Acceptance Criteria

### Extension Command Framework
- [ ] Implement `gitlab_extension_command()` function
- [ ] Handle `gh extension list` gracefully
- [ ] Handle `gh extension install` with appropriate warnings/fallbacks
- [ ] Route extension-specific commands to provider implementations

### Sub-Issue Functionality Simulation
- [ ] Create `gitlab_sub_issue_create()` function
- [ ] Use GitLab issue links API for parent-child relationships
- [ ] Return GitHub CLI compatible JSON output (`{"number": N}`)
- [ ] Add parent reference comments for visibility
- [ ] Support all sub-issue parameters: `--parent`, `--title`, `--body-file`, `--label`

## Implementation Details

### 1. Extension Command Router
```bash
# In lib/providers/gitlab.sh
gitlab_extension_command() {
    local subcmd="$1"; shift
    
    case "$subcmd" in
        "list")
            echo "GitLab provider: Using native issue relationships instead of extensions"
            return 0
            ;;
        "install") 
            local extension="$1"
            case "$extension" in
                "yahsan2/gh-sub-issue")
                    echo "GitLab provider: sub-issue functionality available via native issue links"
                    return 0
                    ;;
                *)
                    echo "Warning: GitLab provider doesn't support extension $extension" >&2
                    echo "Available: native issue relationships" >&2
                    return 1
                    ;;
            esac
            ;;
        *)
            # Route to extension-specific handlers
            if command -v "gitlab_${subcmd}_command" >/dev/null 2>&1; then
                "gitlab_${subcmd}_command" "$@"
            else
                echo "GitLab provider: extension command $subcmd not implemented" >&2
                return 1
            fi
            ;;
    esac
}
```

### 2. Sub-Issue Implementation
```bash
# Route sub-issue commands
gitlab_sub-issue_command() {
    local subcmd="$1"; shift
    case "$subcmd" in
        "create") gitlab_sub_issue_create "$@" ;;
        "list") gitlab_sub_issue_list "$@" ;;
        *) echo "Sub-issue command $subcmd not supported" >&2; return 1 ;;
    esac
}

gitlab_sub_issue_create() {
    local parent_issue="" title="" body_file="" labels=""
    local description=""
    
    # Parse arguments
    while [[ $# -gt 0 ]]; do
        case "$1" in
            "--parent") parent_issue="$2"; shift 2 ;;
            "--title") title="$2"; shift 2 ;;
            "--body-file") body_file="$2"; shift 2 ;;
            "--body") description="$2"; shift 2 ;;
            "--label") labels="$2"; shift 2 ;;
            *) echo "Unknown sub-issue option: $1" >&2; shift ;;
        esac
    done
    
    # Build glab create command
    local create_args=(--title "$title")
    [[ -n "$body_file" ]] && create_args+=(--description-file "$body_file")
    [[ -n "$description" ]] && create_args+=(--description "$description")
    [[ -n "$labels" ]] && create_args+=(--label "$labels")
    
    # Create the issue
    local issue_url=$(glab issue create "${create_args[@]}")
    local issue_number=$(echo "$issue_url" | grep -oE '[0-9]+$')
    
    # Create parent relationship if specified
    if [[ -n "$parent_issue" && -n "$issue_number" ]]; then
        # Method 1: Use GitLab issue links API (requires project ID)
        local project_id=$(glab api user | jq -r '.projects[] | select(.default_branch) | .id' | head -1)
        if [[ -n "$project_id" ]]; then
            glab api "projects/$project_id/issues/$issue_number/links" -X POST \
                -f target_project_id="$project_id" \
                -f target_issue_iid="$parent_issue" \
                -f link_type="relates_to" >/dev/null 2>&1 || {
                # Fallback: Add comment to both issues
                glab issue note "$issue_number" --message "Child of #$parent_issue" >/dev/null 2>&1 || true
                glab issue note "$parent_issue" --message "Parent of #$issue_number" >/dev/null 2>&1 || true
            }
        fi
    fi
    
    # Return GitHub CLI compatible format
    echo "{\"number\": $issue_number, \"html_url\": \"$issue_url\"}"
}
```

### 3. Integration with Main Router
```bash
# In main gitlab provider execute function
gitlab_execute() {
    # ... existing code ...
    case "$cmd" in
        # ... existing commands ...
        "extension") gitlab_extension_command "$@" ;;
        "sub-issue") gitlab_sub-issue_command "$@" ;;
        *) 
            echo "Command not supported: $cmd" >&2
            exit 1
            ;;
    esac
}
```

## Testing Strategy

### Unit Tests
```bash
test_extension_framework() {
    # Test extension list (should not error)
    local output=$(repocli extension list 2>&1)
    assert_success "$?" "Extension list should succeed"
    assert_contains "$output" "native issue relationships" "Should mention GitLab alternative"
}

test_sub_issue_creation() {
    if [[ "$gitlab_test_mode" == "read_only" ]]; then
        return 0  # Skip modification tests
    fi
    
    local parent_issue=$(get_test_issue)
    [[ "$parent_issue" == "SKIP" ]] && return 0
    
    # Create sub-issue
    local result=$(repocli sub-issue create --parent "$parent_issue" --title "Test Sub-Issue" --body "Sub-issue body")
    local sub_issue_num=$(echo "$result" | jq -r '.number')
    
    assert_not_empty "$sub_issue_num" "Should return sub-issue number"
    assert_matches "$sub_issue_num" '^[0-9]+$' "Should be valid issue number"
    
    # Verify relationship exists (check for comment or link)
    local parent_comments=$(glab issue notes "$parent_issue" --output json)
    local sub_comments=$(glab issue notes "$sub_issue_num" --output json)
    
    # At least one should reference the relationship
    local relationship_found=false
    if echo "$parent_comments" | grep -q "#$sub_issue_num"; then
        relationship_found=true
    fi
    if echo "$sub_comments" | grep -q "#$parent_issue"; then
        relationship_found=true  
    fi
    
    assert_true "$relationship_found" "Parent-child relationship should be documented"
    echo "âœ… Sub-issue creation and relationship tracking working"
}
```

## PM System Impact
This task specifically addresses PM commands that currently fail:
- `/pm:epic-sync` - Uses `gh sub-issue create` extensively
- Epic decomposition workflows
- Parent-child issue tracking for epic management

## Dependencies
- Task 20: Main PM system coverage task
- Access to GitLab test repository with API permissions
- Understanding of GitLab issue links API

## Definition of Done
- [ ] `gh extension list` works without errors
- [ ] `gh extension install yahsan2/gh-sub-issue` provides helpful feedback
- [ ] `gh sub-issue create --parent X` creates linked issues on GitLab
- [ ] JSON output matches GitHub CLI format
- [ ] PM system epic-sync works with GitLab provider
- [ ] Comprehensive testing covers edge cases

## Effort Estimate
- Size: M
- Hours: 8-12 hours
- Critical path for PM system GitLab compatibility
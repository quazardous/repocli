---
name: Implement Test Configuration Setup Command
status: completed
created: 2025-08-25T12:13:57Z
updated: 2025-08-25T17:00:00Z
last_sync: 2025-08-25T23:03:33+02:00
github: https://github.com/quazardous/repocli/issues/14
depends_on: [2]
parallel: true
conflicts_with: []
---

# Task: Implement Test Configuration Setup Command

## Description
Enhance the existing `/tests:init` command to provide consistent provider/instance configuration for all cross-testing test cases. The command should ensure that GitHub provider tests, GitLab provider tests, and cross-provider comparisons all use the correct and consistent configuration settings.

**üéØ PRIMARY FOCUS**: Test configuration injection - ensure each test case uses the right provider/instance combination for reliable cross-provider testing.

‚ö†Ô∏è **CURRENT STATUS**: Basic GitLab configuration exists, needs enhancement for comprehensive test configuration management.

## Acceptance Criteria (Enhanced Test Configuration)
- [x] ‚úÖ Create `/tests:init` command script - EXISTS in `.claude/scripts/tests/init.sh`
- [x] ‚úÖ GitLab repository configuration - IMPLEMENTED
- [x] ‚úÖ **Enhanced provider configuration generation** for test consistency - `create_temp_config()` implemented
- [x] ‚úÖ **Test case configuration templates** for each provider/instance combination - GitHub and GitLab templates implemented
- [x] ‚úÖ **Configuration validation** for both GitHub and GitLab providers - `validate_test_configuration()` implemented
- [x] ‚úÖ **Test environment setup** with provider-specific temporary configurations - `setup_test_with_provider()` implemented
- [x] ‚úÖ **Cross-provider test matrix** configuration (GitHub baseline vs GitLab translation) - `run_cross_provider_test()` implemented
- [x] ‚úÖ **Instance-specific configuration** for custom GitLab instances - Custom instance support via .tests.conf
- [x] ‚úÖ Integration with existing test isolation utilities (Task #3) - Sources test-isolation.sh
- [x] ‚úÖ Documentation for test configuration usage patterns - Comprehensive implementation documentation provided

## Technical Details
- Implementation approach: Enhance existing script + add test configuration utilities
- Key considerations: Provider consistency, test isolation, configuration injection
- Code locations/files affected:
  - `.claude/scripts/tests/init.sh` (EXISTS - needs enhancement)
  - `tests/cross-testing/lib/test-config.sh` (new - configuration utilities)
  - `.tests.conf` (enhanced format)
  - Test-specific temporary configurations for each provider

## Implementation Requirements

### Primary Deliverable: `tests/cross-testing/lib/test-config.sh`

**üéØ KEY PRINCIPLE**: Use only `REPOCLI_CONFIG` environment variable for configuration injection - no artificial multiplication of environment variables.

```bash
#!/bin/bash
# Test Configuration Utilities for Cross-Provider Testing
# Uses temporary config files injected via REPOCLI_CONFIG environment variable

create_temp_config() {
    # Create temporary repocli.conf for specified provider
    local provider="$1"
    local temp_config
    temp_config=$(mktemp /tmp/repocli-test-XXXXXX.conf)
    
    debug_log "üîß Creating temporary config for provider: $provider"
    debug_log "üìÑ Temporary config file: $temp_config"
    
    case "$provider" in
        "github")
            echo "provider=github" > "$temp_config"
            debug_log "‚úÖ GitHub provider config created"
            ;;
        "gitlab")
            # Load .tests.conf if it exists for GitLab repository settings
            if [[ -f .tests.conf ]]; then
                source .tests.conf
                debug_log "üìã Loaded GitLab settings from .tests.conf"
                debug_log "   - Instance: ${gitlab_test_instance:-<not set>}"
                debug_log "   - Repository: ${gitlab_test_repo:-<not set>}"
            else
                debug_log "‚ö†Ô∏è  No .tests.conf found, using defaults"
            fi
            echo "provider=gitlab" > "$temp_config"
            local instance="${gitlab_test_instance:-https://gitlab.com}"
            echo "instance=$instance" >> "$temp_config"
            debug_log "‚úÖ GitLab provider config created with instance: $instance"
            ;;
        *)
            debug_log "‚ùå Unknown provider: $provider"
            ;;
    esac
    
    echo "$temp_config"
}

setup_test_with_provider() {
    # Set up test with provider-specific configuration via REPOCLI_CONFIG only
    local provider="$1"
    local temp_config
    temp_config=$(create_temp_config "$provider")
    
    export REPOCLI_CONFIG="$temp_config"
    debug_log "üéØ REPOCLI_CONFIG set to: $REPOCLI_CONFIG"
    debug_log "üìã Provider: $provider"
}

cleanup_test_config() {
    # Clean up temporary configuration - minimal approach
    [[ -n "$REPOCLI_CONFIG" && -f "$REPOCLI_CONFIG" ]] && rm -f "$REPOCLI_CONFIG"
    unset REPOCLI_CONFIG
}

validate_test_configuration() {
    echo "üîç Validating test configuration..."
    
    # Debug: Show configuration file lookup process
    debug_log "üîç Configuration file lookup process:"
    debug_log "  - REPOCLI_CONFIG: ${REPOCLI_CONFIG:-<not set>}"
    debug_log "  - ./repocli.conf: $([ -f ./repocli.conf ] && echo "exists" || echo "not found")"
    debug_log "  - ~/.repocli.conf: $([ -f ~/.repocli.conf ] && echo "exists" || echo "not found")"
    debug_log "  - ~/.config/repocli/config: $([ -f ~/.config/repocli/config ] && echo "exists" || echo "not found")"
    
    # Show active configuration source
    if [[ -n "${REPOCLI_CONFIG:-}" ]]; then
        debug_log "üéØ Active config: $REPOCLI_CONFIG (temporary test config)"
    elif [[ -f ./repocli.conf ]]; then
        debug_log "üéØ Active config: ./repocli.conf (project-specific)"
    elif [[ -f ~/.repocli.conf ]]; then
        debug_log "üéØ Active config: ~/.repocli.conf (user-specific)"
    elif [[ -f ~/.config/repocli/config ]]; then
        debug_log "üéØ Active config: ~/.config/repocli/config (XDG compliant)"
    else
        debug_log "üéØ Active config: none found"
    fi
    
    # Check GitHub CLI availability
    if command -v gh >/dev/null 2>&1; then
        echo "‚úÖ GitHub CLI available"
    else
        echo "‚ö†Ô∏è GitHub CLI not available - GitHub tests will be skipped"
    fi
    
    # Check GitLab CLI availability  
    if command -v glab >/dev/null 2>&1; then
        echo "‚úÖ GitLab CLI available"
        
        # Check .tests.conf for GitLab repository settings
        if [[ -f .tests.conf ]]; then
            echo "‚úÖ GitLab test configuration found"
            debug_log "üìã .tests.conf found for GitLab testing"
        else
            echo "‚ö†Ô∏è No .tests.conf - run /tests:init for GitLab testing"
            debug_log "üìã .tests.conf not found"
        fi
    else
        echo "‚ö†Ô∏è GitLab CLI not available - GitLab tests will be skipped"
    fi
}
```

### Cross-Provider Test Execution Functions

```bash
run_cross_provider_test() {
    # Cross-provider test execution with REPOCLI_CONFIG injection
    local test_function="$1"
    
    echo "üîÑ Cross-provider test: $test_function"
    
    # Test with GitHub provider (baseline)
    echo "üìã GitHub provider test..."
    setup_test_with_provider "github"
    local github_result github_exit
    github_result=$($test_function 2>&1)
    github_exit=$?
    cleanup_test_config
    
    # Test with GitLab provider (translation)
    echo "üìã GitLab provider test..."
    setup_test_with_provider "gitlab" 
    local gitlab_result gitlab_exit
    gitlab_result=$($test_function 2>&1)
    gitlab_exit=$?
    cleanup_test_config
    
    # Compare results
    echo "GitHub exit: $github_exit, GitLab exit: $gitlab_exit"
    [[ $github_exit -eq $gitlab_exit ]] && echo "‚úÖ Exit codes match" || echo "‚ùå Exit codes differ"
}

run_test_with_provider() {
    # Simple single-provider test execution
    local provider="$1"
    local test_function="$2"
    
    setup_test_with_provider "$provider"
    $test_function
    local exit_code=$?
    cleanup_test_config
    return $exit_code
}
```

### Integration with Existing Test Framework

```bash
# Source existing utilities at top of file
source "$(dirname "${BASH_SOURCE[0]}")/test-isolation.sh" 2>/dev/null || true

# Usage examples for other test files
validate_test_configuration  # Before running tests

# Single provider tests
run_test_with_provider "github" my_test_function
run_test_with_provider "gitlab" my_test_function  

# Cross-provider comparison
run_cross_provider_test my_test_function
```

## Configuration Template
The command should create a `.tests.conf` file with this structure:
```ini
# GitLab Cross-Testing Configuration
# Generated by /tests:init on [timestamp]

# GitLab instance (default: https://gitlab.com)
gitlab_test_instance=https://gitlab.com

# Private GitLab repository for testing (required)
gitlab_test_repo=username/repository

# Optional: specific issue number for testing
gitlab_test_issue=123

# Optional: test username
gitlab_test_user=username
```

## User Experience Flow
1. Run `/tests:init`
2. Interactive prompts:
   - "GitLab instance URL [https://gitlab.com]: "
   - "Private GitLab repository (username/repo): "
   - "Test issue number [optional]: "
   - "Test username [optional]: "
3. Validation: Test repository access with `glab api projects/:id`
4. Create configuration files
5. Success message with guidance for running tests

## Error Handling
- Invalid repository format
- Repository access denied (authentication issues)
- Network connectivity problems
- File permission errors
- GitLab CLI not available

## Debug Requirements
- **REPOCLI Debug Visibility**: Ensure `REPOCLI_DEBUG=1` provides verbose logging of:
  - Configuration file path being used (`REPOCLI_CONFIG` or default locations)
  - Provider selection (github/gitlab) 
  - Instance URL for GitLab custom instances
  - Configuration source (temporary test config vs user config)
- **Test Configuration Debug**: Add debug logging to all test-config.sh functions
- **Configuration Validation**: Debug output should show config resolution process

## Security Requirements
- Never log sensitive repository information
- Set restrictive permissions on `.tests.conf` (600)
- Validate input to prevent injection attacks
- Clear instructions about keeping `.tests.conf` private